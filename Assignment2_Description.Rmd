---
title: "Assignment2_Description"
author: "Neli Noykova"
date: "June 11, 2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 16px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 16px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 16px;
}
</style>

# MULTIPLE CORRESPONDANCE ANALYSIS - Assignment 2

# The data 
As in the previous Assignment 1, here we again use **Finnish** sample from [ISSP 2012 survey "Family and Changing Gender Roles IV"](http://www.gesis.org/issp/modules/issp-modules-by-topic/family-and-changing-gender-roles/2012/). Original data involve 1171 observations of 8 variables (4 substantive and 4 demographic). All variables are categorical.

The 4 **substantive** variables, which values are measured in 1-5 scale, are: 

**A**:	Married people are generally happier than unmarried people. 
**B**:	People who want children ought to get married. 
**C**:	It is all right for a couple to live together without intending to get married. 
**D**:	Divorce is usually the best solution when a couple can't seem to work out their marriage problems. 


The **demographic** variables are:
**g**: gender (1=male, 2=female)
**a**: age group (1=16-25, 2=26-35, 3=36-45, 4=46-55, 5=56-65, 6= 66+)
**e**: education (1=Primary, 2=Comprehensive, primary and lower secondary, 3= Post-comprehensive, vocational school or course, 4=General upper secondary education or certificate, 5= Vocational post-secondary non-tertiary education, 6=Polytechnics , 7= University, lower academic degree, BA, 8=University, higher academic degree, MA
**p**: Living in steady partnership (1=Yes, have partner; live in same household, 2=Yes, have partner; don't live in same household, 3=No partner)

Here we do not provide preliminary data treatment. We include all original variables, and also all missing data, denoted with number 9. During the data analyses we simply assign a new category, 9, to the missing data. 

##Graphical overview of the data and summaries of the variables 

The original data, including missing values denoted by number 9, look as: 

```{r}
Finland2 <- read.table("FinlandWithMissing.txt")
head(Finland2)
dim(Finland2)
str(Finland2)
```
# Task 1: Multiple correspondence analysis (MCA) on the four substantive questions. Comparing the results with the case of excluded missing data. 

As it was noted during the lectures, since we analyze the data at the nominal level, a missing value is treated as an additional category (in the example here category 9), which is included during the subset analysis.

We show the results for both data sets (without and with missing data) using the default symmetric plot, where both coordinates are principle. 
We recall the main formulas from MCA (from lecture slides) in order to show the mathematical expression of these coordinates. 

If we denote the data table (Finland.txt or FinlandWithMissing.txt) as **N**, then the correspondence matrix **P** is obtained as: 

$$\mathbf{P} = \left( \frac{1}{n}
\right)\mathbf{N}
$$

If we denote the row and column marginal totals (masses) of **P** as **r** and  **c** respectively, and $$\mathbf{D_r}$$ and $$\mathbf{D_c}$$ 
are the diagonal matrices of these masses, then after applying singular value decomposition (SVD) we obtain: 

$$\mathbf{S} = \mathbf{D^{\left(-1/2\right)}_r} \mathbf{\left(P-rc^T
\right)}\mathbf{D^{\left(-1/2\right)}_c}
$$
which is equivalent to 

$$\mathbf{S} = \mathbf{D^{\left(1/2\right)}_r} \mathbf{\left(D^{\left(-1\right)}_rPD^{\left(-1\right)}_c-11^T\right)}
\mathbf{D^{\left(1/2\right)}_c}
$$

According SVD $$\mathbf{S} = \mathbf{UD_\alpha V^T}$$
Then the principal coordinates are presented as:
 - for rows:  
 
 $$\mathbf{F} = \mathbf{D^{\left(-1/2\right)}_rUD_{\alpha}}$$
  - for columns:  
 
 $$\mathbf{G} = \mathbf{D^{\left(-1/2\right)}_c V D_{\alpha}}$$
 
The total variance (inertia) is the sum of squares of the elements of 
 $$\mathbf{S} = \mathbf{trace\left(SS^T\right) = {\chi}^2/n}$$
 
 The Chi-square distance 
 $${\chi}^2 = \sum_{i=1}^r\sum_{j=1}^c\frac{\left(fo_{ij}-fe_{ij}\right)^2}{fe_{ij}}$$
 
In this expression the observed and expected frequencies of the cell in row i and column j are denoted by $$fo_{ij}$$ and $$fe_{ij}$$ respectively. 


We first provide MCA on data Finland.txt, where missed data are excluded and draw the default symmetric plot. 

```{r}
require(ca)
Finland <- read.table("Finland.txt")
par(mar=c(4.2,4,1,1), mgp=c(2,0.7,0), cex.axis=0.8, font.lab=2, mfrow=c(1,1))
plot(mjca(Finland[,1:4], ps=""), mass=c(F,T))
```

Next perform the same MCA analysis and plot, but using also missed data as separate category = 9: 

```{r}
par(mar=c(4.2,4,1,1), mgp=c(2,0.7,0), cex.axis=0.8, font.lab=2, mfrow=c(1,1))
plot(mjca(Finland2[,1:4], ps=""), mass=c(F,T))
```

We observe that the missing category 9 for all 4 substantive questions is situated on the right down part of the biplot, where both principal coordinates take negative values. 

The symmetric plot represents the row and column profiles simultaneously in a common space. According Mike Bendixen (Marketing Bulletin, 2003, 14) this plot may lead to misinterpretation if examined in isolation or only visually because principal coordinates are presented for both rows and columns. These coordinates represent the row and column profiles and not the apexes for which the standard coordinates are required. Therefore in such cases asymmetric plots are recommended. 

# Task 2: Burt matrix. Performing CA using a subset of non-missing rows and columns. Confidence regions of the demographic groups. 

The part of Burt matrix on first 4 substantive questions can be obtained as: 
```{r}
require(ca)
Finland2.B <- mjca(Finland2[,1:4])$Burt
```

Since the missing values are involved in this matrix as separate category, we need to take the following part of Burt matrix:

```{r}
Finland2.ABCD = Finland2.B[c(1:24), c(1:24)]
Finland2.ABCD
summary(Finland2.ABCD)
```

For our work we need also to calculate the indicator matrix, obtained also via the MCA function **mjca**: 
```{r}
Finland2.Z <- mjca(Finland2[,1:4], ps="", reti=T)$indmat
head(Finland2.Z)
dim(Finland2.Z)
```

The relationship between both matrices is: 
$$\mathbf{B} = \mathbf{Z^TZ}$$
The non-missing categories are obtained by excluding the missing ones. Further analysis is provided using subset CA: 

```{r}
Finland2.nonmissing <- -c(6,12,18,24)
Finland2.mca1 <- ca(Finland2.B, subsetrow=c(Finland2.nonmissing), subsetcol=c(Finland2.nonmissing))
plot(Finland2.mca1, what=c("none", "all"), mass=c(F,T), font.lab=2)
summary(Finland2.mca1)
```

This plot is quite similar to the plot, obtained when missing data are removed from the data set. 

Next we add responding points to the plot. For this purpose we first transform the corresponding frequencies in the table and draw a sequence of points at the specified coordinates: 

```{r}
Finland2.sum <- apply(Finland2.Z[,c(Finland2.nonmissing)], 1, sum) 
Finland2.sum[Finland2.sum==0] <- 1
Finland2.rpc <- Finland2.Z[,c(Finland2.nonmissing)] %*% Finland2.mca1$colcoord / Finland2.sum
plot(Finland2.mca1, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc, pch=19, col="lightblue", cex=0.8)
```

Next we compute confidence regions of demographic groups. For this purpose we have to add group ellipses and use Prof. Greenacre's program "confidenceplots", which was given separately. 

```{r}
require(ellipse)
source("confidenceplots.R")
```

First we draw **confidence plots** for the demographic group **partnership** by generation asymmetric plot, adding points and finally draw confidence plots. 

```{r}
plot(Finland2.mca1, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc, pch=19, col="lightblue", cex=0.8)
confidenceplots(Finland2.rpc[Finland2$p<4,1], Finland2.rpc[Finland2$p<4,2], group=Finland2$p[Finland2$e<4], groupcols=rep("purple",5), shade=T,
                groupnames=c("ph1","p2","nop3"), shownames=T, add=T)

```


Next we draw confidence plot for the demographic group **education**. 

```{r}
plot(Finland2.mca1, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc, pch=19, col="lightblue", cex=0.8)
confidenceplots(Finland2.rpc[Finland2$e<9,1], Finland2.rpc[Finland2$e<9,2], group=Finland2$e[Finland2$e<9], groupcols=rep("forestgreen",8), shade=T,
                groupnames=c("e1","e2","e3","e4","e5","e6","e7","e8"), shownames=T, add=T)

```
The confidence plot for the demographic group **gender** is: 

```{r}
plot(Finland2.mca1, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc, pch=19, col="lightblue", cex=0.8)
confidenceplots(Finland2.rpc[Finland2$g<3,1], Finland2.rpc[Finland2$g<3,2], group=Finland2$g[Finland2$g<3], groupcols=rep("blue",6), shade=T,
                groupnames=c("m","f"), shownames=T, add=T)
```

The confidence plot for the demographic group **age** is:

```{r}
plot(Finland2.mca1, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc, pch=19, col="lightblue", cex=0.8)
confidenceplots(Finland2.rpc[Finland2$a<7,1], Finland2.rpc[Finland2$a<7,2], group=Finland2$a[Finland2$a<7], groupcols=rep("blue",6), shade=T,
                groupnames=c("a1","a2","a3","a4","a5","a6"), shownames=T, add=T)

```

If we plot **only the confidence plots (just the ellipses)** for every demographic group, the plots will look as follow: 

- for the demographic group **partnership**: 

```{r}
plot(Finland2.rpc, type="n", asp=1, xlab="Subset CA dim1 (20.7%)", ylab="Subset CA dim1 (17.9%)", xlim=c(-0.5,0.5), ylim=c(-0.5,0.5))
abline(v=0, h=0, lty=2, col="grey") 
confidenceplots(Finland2.rpc[Finland2$p<4,1], Finland2.rpc[Finland2$p<4,2], group=Finland2$p[Finland2$p<4], groupcols=rep("purple",5), shade=T,
                groupnames=c("ph1","p2","nop3"), shownames=T, add=T)

```

- for the demographic group **education**: 

```{r}
plot(Finland2.rpc, type="n", asp=1, xlab="Subset CA dim1 (20.7%)", ylab="Subset CA dim1 (17.9%)", xlim=c(-1,1), ylim=c(-0.5,0.5))
abline(v=0, h=0, lty=2, col="grey") 
confidenceplots(Finland2.rpc[Finland2$e<9,1], Finland2.rpc[Finland2$e<9,2], group=Finland2$e[Finland2$e<9], groupcols=rep("forestgreen",8), shade=T,
                groupnames=c("e1","e2","e3","e4","e5","e6","e7","e8"), shownames=T, add=T)

```

- for the demographic group **gender**: 

```{r}
plot(Finland2.rpc, type="n", asp=1, xlab="Subset CA dim1 (20.7%)", ylab="Subset CA dim1 (17.9%)", xlim=c(-0.5,0.5), ylim=c(-0.2,0.2))
abline(v=0, h=0, lty=2, col="grey") 
confidenceplots(Finland2.rpc[Finland2$g<3,1], Finland2.rpc[Finland2$g<3,2], group=Finland2$g[Finland2$g<3], groupcols=rep("blue",6), shade=T,
                groupnames=c("m","f"), shownames=T, add=T)

```

- for the demographic group **age**: 

```{r}
plot(Finland2.rpc, type="n", asp=1, xlab="Subset CA dim1 (20.7%)", ylab="Subset CA dim1 (17.9%)", xlim=c(-1,1), ylim=c(-0.5,0.5))
abline(v=0, h=0, lty=2, col="grey") 
confidenceplots(Finland2.rpc[Finland2$a<7,1], Finland2.rpc[Finland2$a<7,2], group=Finland2$a[Finland2$a<7], groupcols=rep("blue",6), shade=T,
                groupnames=c("a1","a2","a3","a4","a5","a6"), shownames=T, add=T)
```

##Task 3: Analysis of the "middle" and "missing" values of the substantive variables. Confidence intervals of the demographic groups.

Analysis of **"middle"** category could be provided via CA of Burt matrix. 

```{r}
# investigation of "middle" category, via the Burt matrix
#seq() - generates a sequence of numbers
#seq(from=3,  to=46, by=6): 3,9,15,21,27,33,39,45
Finland2.middle <- seq(3,22,6) 
Finland2.mca2 <- ca(Finland2.B, subsetrow=Finland2.middle, subsetcol=seq(3,22,6))
#what - Vector of two character strings specifying the contents of the plot.
#First entry sets the rows and the second entry the columns. Allowed values # are "all" (all available points, default)
#"active" (only active points are displayed)
#"passive" (only supplementary points are displayed)
#"none" (no points are displayed)
#The status (active or supplementary) of columns is set in mjca using the option
#supcol.
# mass - area, first - rows, second - columns
#font.lab - labels for font? 
plot(Finland2.mca2, what=c("none", "all"), mass=c(F,T), font.lab=2)
summary(Finland2.mca2)
```

Adding respondent points only for **middle** categories: 

```{r}
#Finland2.Z - indicator matrix
# apply(variable, margin, function). - Returns a vector or array or list of values obtained by applying 
#a function to margins of an array or matrix
#margin specifies if you want to apply by row (margin = 1), 
#by column (margin = 2), or for each element (margin = 1:2).
Finland2.sum4 <- apply(Finland2.Z[,c(Finland2.middle)], 1, sum) 
Finland2.sum4[Finland2.sum4==0] <- 1
Finland2.rpc5 <- Finland2.Z[,c(Finland2.middle)] %*% Finland2.mca2$colcoord / Finland2.sum4
plot(Finland2.mca2, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc5, pch=19, col="lightblue", cex=0.8)
```




Only **missing** categories are obtained as: 
```{r}
Finland2.missing <- c(6,12,18,24)
Finland2.mca4 <- ca(Finland2.B, subsetrow=c(Finland2.missing), subsetcol=c(Finland2.missing))
plot(Finland2.mca4, what=c("none", "all"), mass=c(F,T), font.lab=2)
```

Adding respondent points only for **missing** categories: 

```{r}
Finland2.sum2 <- apply(Finland2.Z[,c(Finland2.missing)], 1, sum) 
Finland2.sum2[Finland2.sum2==0] <- 1
Finland2.rpc3 <- Finland2.Z[,c(Finland2.missing)] %*% Finland2.mca4$colcoord / Finland2.sum2
plot(Finland2.mca4, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc3 , pch=19, col="lightblue", cex=0.8)
```


**Both "middle" and missing** categories are investigated again using CA of Burt matrix. 

```{r}
Finland2.missing <- c(6,12,18,24)
Finland2.mca3 <- ca(Finland2.B, subsetrow=c(Finland2.middle,Finland2.missing), subsetcol=c(Finland2.middle,Finland2.missing))
plot(Finland2.mca3, what=c("none", "all"), mass=c(F,T), font.lab=2)

```

Adding respondent points only for **both "middle" and missing** categories: 
```{r}
Finland2.sum1 <- apply(Finland2.Z[,c(Finland2.middle,Finland2.missing)], 1, sum) 
Finland2.sum1[Finland2.sum1==0] <- 1
Finland2.rpc2 <- Finland2.Z[,c(Finland2.middle,Finland2.missing)] %*% Finland2.mca3$colcoord / Finland2.sum1
plot(Finland2.mca3, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc2 , pch=19, col="lightblue", cex=0.8)
```

Next we compute confidence regions of demographic groups for **both missing and "middle"** groups. 

- confidence plot for the demographic group **partnership**

```{r}
#generated assymmetric plot
plot(Finland2.mca3, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
#add points
points(Finland2.rpc2, pch=19, col="lightblue", cex=0.8)
#draw confidence plots
confidenceplots(Finland2.rpc2[Finland2$p<4,1], Finland2.rpc2[Finland2$p<4,2], group=Finland2$p[Finland2$p<4], groupcols=rep("purple",5), shade=T,
                groupnames=c("ph1","p2","nop3"), shownames=T, add=T)
```

- confidence plot for the demographic group **education**

```{r}
plot(Finland2.mca3, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc2, pch=19, col="lightblue", cex=0.8)
confidenceplots(Finland2.rpc2[Finland2$e<9,1], Finland2.rpc2[Finland2$e<9,2], group=Finland2$e[Finland2$e<9], groupcols=rep("forestgreen",8), shade=T,
                groupnames=c("e1","e2","e3","e4","e5","e6","e7","e8"), shownames=T, add=T)

```

- confidence plot for the demographic group **gender**

```{r}
plot(Finland2.mca3, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc2, pch=19, col="lightblue", cex=0.8)
confidenceplots(Finland2.rpc2[Finland2$g<3,1], Finland2.rpc2[Finland2$g<3,2], group=Finland2$g[Finland2$g<3], groupcols=rep("blue",6), shade=T,
                groupnames=c("m","f"), shownames=T, add=T)
```

- confidence plot for the demographic group **age**

```{r}
plot(Finland2.mca3, what=c("none", "all"), mass=c(F,T), font.lab=2, map="rowprincipal")
points(Finland2.rpc2, pch=19, col="lightblue", cex=0.8)
confidenceplots(Finland2.rpc2[Finland2$a<7,1], Finland2.rpc2[Finland2$a<7,2], group=Finland2$a[Finland2$a<7], groupcols=rep("blue",6), shade=T,
                groupnames=c("a1","a2","a3","a4","a5","a6"), shownames=T, add=T)

```

Since from these plots the confidence regions are not so clear, similarly as in Task 2, we next plot **"just the ellipses"**. 

- for the demographic group **partnership**:

```{r}
plot(Finland2.rpc2, type="n", asp=1, xlab="Subset CA dim1 (48.6%)", ylab="Subset CA dim1 (13.5%)", xlim=c(-1,1), ylim=c(0,2))
abline(v=0, h=0, lty=2, col="grey") 
#draw confidence plots
confidenceplots(Finland2.rpc2[Finland2$p<4,1], Finland2.rpc2[Finland2$p<4,2], group=Finland2$p[Finland2$e<4], groupcols=rep("purple",5), shade=T,
                groupnames=c("ph1","p2","nop3"), shownames=T, add=T)

```

- for the demographic group **education**:

```{r}
plot(Finland2.rpc2, type="n", asp=1, xlab="Subset CA dim1 (48.6%)", ylab="Subset CA dim1 (13.5%)", xlim=c(-1,1), ylim=c(0.5,1.5))
abline(v=0, h=0, lty=2, col="grey") 
confidenceplots(Finland2.rpc2[Finland2$e<9,1], Finland2.rpc2[Finland2$e<9,2], group=Finland2$e[Finland2$e<9], groupcols=rep("forestgreen",8), shade=T,
                groupnames=c("e1","e2","e3","e4","e5","e6","e7","e8"), shownames=T, add=T)

```

- for the demographic group **gender**:

```{r}
plot(Finland2.rpc2, type="n", asp=1, xlab="Subset CA dim1 (48.6%)", ylab="Subset CA dim1 (13.5%)", xlim=c(0,0.5), ylim=c(0.8,1.4))
abline(v=0, h=0, lty=2, col="grey") 
confidenceplots(Finland2.rpc2[Finland2$g<3,1], Finland2.rpc2[Finland2$g<3,2], group=Finland2$g[Finland2$g<3], groupcols=rep("blue",6), shade=T,
                groupnames=c("m","f"), shownames=T, add=T)

```

- for the demographic group **age**:

```{r}
plot(Finland2.rpc2, type="n", asp=1, xlab="Subset CA dim1 (48.6%)", ylab="Subset CA dim1 (13.5%)", xlim=c(-0.5,1), ylim=c(0.5,1.5))
abline(v=0, h=0, lty=2, col="grey") 
confidenceplots(Finland2.rpc2[Finland2$a<7,1], Finland2.rpc2[Finland2$a<7,2], group=Finland2$a[Finland2$a<7], groupcols=rep("blue",6), shade=T,
                groupnames=c("a1","a2","a3","a4","a5","a6"), shownames=T, add=T)

```

From all analyses, provided in Task 3, we can conclude that MCA is a powerful tool for investigating missing and "middle" categories. 
Both categories involve quite big amount of uncertainty, because of which most of the other methods just ignore these cases. 
Here we have seen how the information from both categories could be utilized applying MCA approach. 


##Used and useful links

[Package ‘ca’](https://cran.r-project.org/web/packages/ca/ca.pdf)

[Oleg Nenadic and Michael Greenacre, Computation of Multiple Correspondence
Analysis, with code in R](https://core.ac.uk/download/pdf/6591520.pdf)

[Michael Greenacre, Biplots in practise](http://www.multivariatestatistics.org/biplots.html)

[Multiple Correspondence Analysis Essentials: Interpretation and application to investigate the associations between categories of multiple qualitative variables - R software and data mining](http://www.sthda.com/english/wiki/multiple-correspondence-analysis-essentials-interpretation-and-application-to-investigate-the-associations-between-categories-of-multiple-qualitative-variables-r-software-and-data-mining)

Mike Bendixen, A Practical Guide to the Use of Correspondence Analysis in
Marketing Research, Marketing Bulletin, 2003, 14, Technical Note 2. 

[An Example R Markdown] (http://www.statpower.net/Content/310/R%20Stuff/SampleMarkdown.html)

[Writing Mathematic Fomulars in Markdown](http://csrgxtu.github.io/2015/03/20/Writing-Mathematic-Fomulars-in-Markdown/)


