---
output:
  pdf_document: default
  html_document: default
  word_document: default
---
<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 16px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 16px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 16px;
}
</style>

# MULTIPLE CORRESPONDANCE ANALYSIS - Assignment 1

conducted by Neli Noykova. 

# The data 
In this exercise set we use **Finnish** sample from [ISSP 2012 survey "Family and Changing Gender Roles IV"](http://www.gesis.org/issp/modules/issp-modules-by-topic/family-and-changing-gender-roles/2012/). Original data involve 1171 observations of 8 variables (4 substantive and 4 demographic). All variables are categorical.

The 4 **substantive** variables, which values are masured in 1-5 scale, are: 

**A**:	Married people are generally happier than unmarried people. 
**B**:	People who want children ought to get married. 
**C**:	It is all right for a couple to live together without intending to get married. 
**D**:	Divorce is usually the best solution when a couple can't seem to work out their marriage problems. 


The **demographic** variables are:
**g**: gender (1=male, 2=female)
**a**: age group (1=16-25, 2=26-35, 3=36-45, 4=46-55, 5=56-65, 6= 66+)
**e**: education (1=Primary, 2=Comprehensive, primary and lower secondary, 3= Post-comprehensive, vocational school or course, 4=General upper secondary education or certificate, 5= Vocational post-secondary non-tertiary education, 6=Polytechnics , 7= University, lower academic degree, BA, 8=University, higher academic degree, MA
**p**: Living in steady partnership (1=Yes, have partner; live in same household, 2=Yes, have partner; don't live in same household, 3=No partner)


The data wrangling includes the following changes: 

1. The missing data ae removed (this has already been provided). The number of observations without missing data is N=924.  

2. For Task 2 a combined variable **ga**, describing the intraction of gender and age categories, is formed as: **ga = 6*(g-1) + a**


##Graphical overview of the data and summaries of the variables 

The preliminary treated data look as: 

```{r}
Finland <- read.table("Finland.txt")
head(Finland)
dim(Finland)
str(Finland)
```

# Task 1: Cross-tabulations and correspondance analysis (CA). 

The goal is to discover interesting relations among the measurements on A, ..., D, g, ..., p. 
Correspondence analysis is a descriptive/exploratory technique designed to analyse simple two-way and multi-way tables containing some measure of correspondence between the rows and columns. 
CA may also be defined as a special case of Principal Components Analysis of the rows and columns of a table, especially applicable to a cross-tabulation. 
Principal components analysis is used for tables consisting of continuous measurement, whereas CA is applied to contingency tables (i.e. cross-tabulations).
The goal of CA is to transform a table of numerical information into a graphical display, in which each row and each column is depicted as a point. Thus CA can be used for data visualization or data pre-processing before applying methods for supervised learning. We can apply this technique for dimensionality reduction.


First we provide a cross-tabulation between the age variable **a** and answer **A**: Married people are generally happier than unmarried people. 
The variable **a** consists of 6 age groups, corresponding to rownames of crosstable: **a1** = 16-25, **a2**=26-35, **a3** = 36-45, **a4** = 46-55, **a5** = 56-65, **a6** = 66+
The categorical variable **A** assume 5 possible values, which correspond to column names of cross-table: **SA** - strongly agree; **A** - agree, **NN** - neither agree or disagree, **D** - disagree, **SD** - strongly disagree. 

```{r}
tab <-table(Finland[,"a"], Finland[,"A"])

rownames(tab) <- c("a1","a2","a3","a4","a5","a6") 
colnames(tab) <- c("SA","A","NN","D","SD")

tab
```

From this table we see that the biggest part of age group **a5** agree with question **A**. Since these values are absolute, we need more precise information wich could be obtained row and column profiles, calculated from this cross-table. We need also to  calculate the chi-square statistic as it has been shown durint the second exercise session. 


An alternative means of extracting the nature of the dependency between the rows and columns of the contingency table is to represent the row or column profiles graphically.

```{r}
require(ca)
plot(ca(tab))
```

This plot is assymetric because the row profiles are plotted simultaneously with apexes representing the columns. 
**a3** is strongly "associated" with answer NN, which is clearly the case from the profile presented in the cross-table. Likewise we observe some proximity of **a5** to the apex representing **A** answer to question A. 
The fact that **a1**, **a2** and **a4** are positioned relatively far away from answers **SA** and **A** means that these younger people rather disagree then agree with the statement A. The age group **a6** is far from all answers of **A**, which probably means that people from this age group do not care so much about statement **A**. 


As a second example we conduct cross-tabulation between the variable **p** (if there is a partner and they live together) and answer **C*: C:	It is all right for a couple to live together without intending to get married. 
The obtained cross-table and resulting plot from CA are:
```{r}
#Cross-tabulations
#between g and D
tab2 <-table(Finland[,"p"], Finland[,"C"])

rownames(tab2) <- c("Live together","Not live together", "No partner") 
colnames(tab2) <- c("SA","A","NN","D","SD")
tab2

require(ca)
plot(ca(tab2))
```
From the cross-tabulation and CA plot becomes clear that people, who live together, tend to give positive answer to the statement **C**. 


As a third example we investigate relationship between education **e** and statement **A**: 

```{r}
tab1 <-table(Finland[,"e"], Finland[,"A"])
rownames(tab1) <- c("Primary","Comprehensive", "Post-comprehensive", "General", "Vocational", "Polytechnics", "University, B", "University, MSc") 
colnames(tab1) <- c("SA","A","NN","D","SD")
tab1

require(ca)
plot(ca(tab1))
```

From this plot becomes clear that no one of the educational gruops strongly afrees with the statement **A**. The highly educated people with university degrees tend to answer using middle alternative. 


##Task 2: Cross-tabulation of **ga** demographic variable against one of the substantive variables. Performing CA. 

The variable **ga**, which is the interaction of gender and age categories, is created as: 
```{r}
Finland$ga <- 6*(Finland$g-1) + Finland$a
head(Finland)
str(Finland)
```

The cross-tabulation between **ga** and **A** is computed as: 
```{r}
tab3 <-table(Finland[,"ga"], Finland[,"C"])
rownames(tab3) <- c("Ma1","Ma2", "Ma3", "Ma4", "Ma5", "Ma6", "Fa1","Fa2", "Fa3", "Fa4", "Fa5", "Fa6") 
colnames(tab3) <- c("SA","A","NN","D","SD")
tab3

```


The CA between **ga** and **A**: 

```{r}
require(ca)
plot(ca(tab3))
```

From this plot becomes clear that female of age group 4 most often strongly agree with the statement **A**, while males in age group 5 most often agree with **A**. 

##Task 3:Computation of the Burt matrix on the questions and demographics together. 

The most classical and standard approach to MCA is to apply a simple CA to the indicatormatrix Z. The indicator matrix Z = {zij} corresponds to a binary coding of the factors - instead of using a factor with Jq levels one uses Jq columns containing binary values, also called dummy variables.
The Burt matrix C is obtained directly from the indicator matrix Z: C = ZTZ.
Burt matrix concatenates all two-way cross-tabulations
between pairs of variables


The Burt matrix is computed as: 
```{r}
require(ca)
Finland.B <- mjca(Finland)$Burt
head(Finland.B)
summary(Finland.B)
```

We take the stacked tables of **A** and **D** substantive variables from the whole Burt matrix: 

```{r}
Finland.AD = Finland.B[c(1:5,16:20), c(1:5,16:20)]
```

The principal intervals (eigenvalues) are: 

```{r}
summary(Finland.AD)
```


The computation of MCA is the application of the (simple) CA algorithm to the Burt matrix C.

The following CA is conducted: 
```{r}
plot(Finland.AD, main="MCA=CA of Burt")
```

##Task 4: Multiple correspondence analysis (MCA) on the four substantive questions. 

Here I use the script from Exercise set 2 about joint correspondance analysis and its fit to two-way tables: 

```{r}
Finland.mca <- mjca(Finland[,1:4], ps="", lambda="JCA")
par(mar=c(4.2,4,3,1), mfrow=c(1,1), font.lab=2)
plot(Finland.mca, main="Joint correspondence analysis")

```



##Task 5:	MCA on the four substantive questions: computing the case points, and adding confidence ellipses for some demographic groups. 

The example code from Exercise set 3 is used, only data are different.  

##5.1 MCA on the four substantive questions

MCA is the CA of indicator matrix: 

```{r}
require(ca)
Finland.mca1 <- mjca(Finland[,1:4], lambda="indicator", ps="", reti=T)
sum(Finland.mca1$sv^2)
summary(Finland.mca1)
```

We calculate: 
- the number of categories: 
```{r}
J <- 4*5 -1
```
The number of substantive questions is Q=4. 
Then: 
```{r}
Q <- 4 
(J-Q)/Q

```

We check the contents of these components of the mjca object (eigenvalues (squared singular values),standard coordinates of columns, standard coordinates of first 10 rows, variable names, category names, first 10 rows of 924 x 20 indicator matrix, first 20 rows and columns of 20 x 20 Burt matrix)  :

```{r}
names(Finland.mca1)
Finland.mca1$sv^2                  # eigenvalues (squared singular values) on all 31 dimensions
Finland.mca1$colcoord[,1:4]        # standard coordinates of columns
Finland.mca1$rowcoord[1:10,1:4]    # standard coordinates of first 10 rows
Finland.mca1$colnames              # variable names
Finland.mca1$levelnames            # category names
Finland.mca1$indmat[1:10,]         # first 10 rows of 924 x 20 indicator matrix
Finland.mca1$Burt[1:20, 1:20]      # first 20 rows and columns of 20 x 20 Burt matrix

```
Next we  compute positions of cases and plot them. 
```{r}
Finland.rpc <- Finland.mca1$indmat %*% Finland.mca1$colcoord[,1:2] / 4
par(mar=c(4.2,4,1,1), mgp=c(2,0.7,0), mfrow=c(1,1), font.lab=2)
plot(Finland.mca1, labels=c(0,0), map="rowprincipal", col=c("black","white"))
points(Finland.rpc, pch=19, cex=0.5, col="lightblue")
text(Finland.mca1$colcoord, labels=Finland.mca1$levelnames, col="red", font=4, cex=0.8)

```

The MCA is calculated as a CA of Burt matrix: 
```{r}
Finland.mca2 <- mjca(Finland[,1:4], lambda="Burt", ps="")
sum(Finland.mca2$sv^2)
summary(Finland.mca2)
```


The default plot shows principal coordinates: 
```{r}
plot(Finland.mca2) 
```

The adjusted MCA is the default of mjca function: 
```{r}
Finland.mca3 <- mjca(Finland[,1:4], ps="")
summary(Finland.mca3)
```

A joint correspondence analysis is used for optimal fit to two-way tables:
```{r}
Finland.mca4 <- mjca(Finland[,1:4], ps="", lambda="JCA")
par(mar=c(4.2,4,3,1), mfrow=c(1,1), font.lab=2)
plot(Finland.mca4, main="Joint correspondence analysis")
summary(Finland.mca4)
```

##5.2 Demographics is superimposed on an MCA

Call the used code about confidence plots, package ellipse, and calculated individual points:

```{r}
source("confidenceplots.R")
require(ellipse)
Finland.rpc <- Finland.mca1$indmat %*% Finland.mca1$colcoord[,1:2] / 4
```

The demographic groups are: education e, partnership p and ga groups.Their confidence plots are : 

```{r}
par(mar=c(4.2,4,1,1), mgp=c(2,0.7,0), mfrow=c(1,1), font.lab=2)
plot(Finland.mca3, labels=c(0,0), map="rowprincipal", col=c("black","white"))
points(Finland.rpc, pch=19, cex=0.5, col="lightblue")
text(Finland.mca1$colcoord, labels=Finland.mca1$levelnames, col="red", font=4, cex=0.8)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"e"]), groupcols=rep("forestgreen",6), shownames=T, add=T)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"p"]), groupcols=rep("purple",6), shownames=T, add=T)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"ga"]), groupcols=rep("chocolate",6), shownames=T, add=T)

lines(matrix(c(-0.5,-0.6, -0.5,0.4, 0.5,0.4, 0.5,-0.6, -0.5,-0.6), ncol=2, byrow=T), lty=2, col="gray30", lwd=2)

```

We zoom in to the group means and confidence ellipses:
```{r}
plot(Finland.mca3, labels=c(0,0), map="rowprincipal", col=c("black","white"), xlim=c(-0.5,0.5), ylim=c(-0.6,0.4))
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"e"]), groupcols=rep("forestgreen",6), shownames=T, add=T)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"p"]), groupcols=rep("purple",6), shownames=T, add=T)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"ga"]), groupcols=rep("chocolate",6), shownames=T, add=T)


plot(Finland.mca3, labels=c(0,0), map="rowprincipal", col=c("black","white"), xlim=c(-0.5,0.5), ylim=c(-0.6,0.4))
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"ga"]), groupcols=c(rep("blue",6),rep("red",6)), 
                groupnames=c("ma1","ma2","ma3","ma4","ma5","ma6","fa1","fa2","fa3","fa4","fa5","fa6"),shownames=T, add=T)

```

And add shading: 
```{r}
plot(Finland.mca3, labels=c(0,0), map="rowprincipal", col=c("black","white"), xlim=c(-0.5,0.5), ylim=c(-0.6,0.4))
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"ga"]), groupcols=c(rep("blue",6),rep("red",6)), shade=T,
                groupnames=c("ma1","ma2","ma3","ma4","ma5","ma6","fa1","fa2","fa3","fa4","fa5","fa6"),shownames=T, add=T)

```
Next we go back to original plot, with category labels, gender-age labels slightly smaller (cex=0.8)

```{r}
par(mar=c(4.2,4,1,1), mgp=c(2,0.7,0), mfrow=c(1,1), font.lab=2)
plot(Finland.mca3, labels=c(0,0), map="rowprincipal", col=c("black","white"))
points(Finland.rpc, pch=19, cex=0.5, col="lightblue")
text(Finland.mca1$colcoord, labels=Finland.mca1$levelnames, col="red", font=4, cex=0.8)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"ga"]), groupcols=c(rep("blue",6),rep("red",6)), shade=T,
                groupnames=c("ma1","ma2","ma3","ma4","ma5","ma6","fa1","fa2","fa3","fa4","fa5","fa6"),shownames=T, add=T, cex=0.8)

```


Back to other demographic variable, education: 
```{r}
par(mar=c(4.2,4,1,1), mgp=c(2,0.7,0), mfrow=c(1,1), font.lab=2)
plot(Finland.mca3, labels=c(0,0), map="rowprincipal", col=c("black","white"))
points(Finland.rpc, pch=19, cex=0.5, col="lightblue")
text(Finland.mca1$colcoord, labels=Finland.mca1$levelnames, col="red", font=4, cex=0.8)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"e"]), groupcols=rep("forestgreen",6), shade=T,
                shownames=T, add=T, cex=0.8)
```


Plot confidence ellipses for all demographic groups together in a zoom:
```{r}
plot(Finland.mca3, labels=c(0,0), map="rowprincipal", col=c("black","white"), xlim=c(-0.5,0.5), ylim=c(-0.6,0.4))
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"p"]), groupcols=rep("purple",6), shade=T,
                groupnames=c("liveTog","liveSep","Single"), shownames=T, add=T)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"e"]), groupcols=rep("forestgreen",6), shade=T,
                groupnames=c("e0","e1","e2","e3","e4","e5"), shownames=T, add=T)
confidenceplots(Finland.rpc[,1], Finland.rpc[,2], group=factor(Finland[,"ga"]), groupcols=c(rep("blue",6),rep("red",6)), shade=T,
                groupnames=c("ma1","ma2","ma3","ma4","ma5","ma6","fa1","fa2","fa3","fa4","fa5","fa6"),shownames=T, add=T)


```

##Used and useful links

[Mike Bendixen, A Practical Guide to the Use of Correspondence Analysis in
Marketing Research](http://marketing-bulletin.massey.ac.nz/V14/MB_V14_T2_Bendixen.pdf)

[Oleg Nenadic and Michael Greenacre, Computation of Multiple Correspondence
Analysis, with code in R](https://core.ac.uk/download/pdf/6591520.pdf)

[Biplots in practise](http://www.multivariatestatistics.org/biplots.html)

[Multiple Correspondence Analysis Essentials: Interpretation and application to investigate the associations between categories of multiple qualitative variables - R software and data mining](http://www.sthda.com/english/wiki/multiple-correspondence-analysis-essentials-interpretation-and-application-to-investigate-the-associations-between-categories-of-multiple-qualitative-variables-r-software-and-data-mining)



